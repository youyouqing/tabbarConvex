//
//  RunningView.m
//  RCSports
//
//  Created by liveidzong on 9/21/16.
//  Copyright © 2016 SBM. All rights reserved.
//

#import "RunningView.h"
#import "Masonry.h"

@interface RunningView()
//@property(nonatomic,strong) CAGradientLayer *gradientLayer;
@property(nonatomic,weak)IBOutlet UIView *gradientView;
@property(nonatomic,assign)float progress;
@end
@implementation RunningView
- (void)drawCircle {
    //创建一个layer并添加到self.layer上面去
    CAShapeLayer *layer = [CAShapeLayer layer];
    layer.frame =  self.gradientView.bounds;
    [self.gradientView.layer addSublayer:layer];
    //创建一个圆
    CGFloat width = CGRectGetWidth( self.gradientView.bounds);
    CGFloat height = CGRectGetHeight( self.gradientView.bounds);
    UIBezierPath *path = [UIBezierPath bezierPathWithArcCenter:CGPointMake(width/2, width/2) radius:width/2.0 startAngle:0 endAngle:2* M_PI clockwise:YES];
    layer.path = path.CGPath;
    layer.fillColor = [UIColor clearColor].CGColor;
    layer.strokeColor = [UIColor getColor:@"DCE6EF"].CGColor;
    layer.lineWidth = 10;
    layer.lineCap = kCALineCapRound;
}
- (void)updateProgressCircle{
 
    self.progress = (float) (0.3);
    [self drawColorLayer];
    
}
//设置整个view渐变色
- (void)drawColorLayer {
    CAShapeLayer *layer = [CAShapeLayer layer];
    layer.frame = self.gradientView.bounds;
    [ self.gradientView.layer addSublayer:layer];
    
    layer.frame =  self.gradientView.bounds;
    layer.lineWidth = 10;
    UIBezierPath *progressCircle = [UIBezierPath bezierPathWithArcCenter:CGPointMake( self.gradientView.bounds.size.width / 2, self.gradientView.bounds.size.width / 2)
                                                                  radius:self.gradientView.bounds.size.width/2.0
                                                              startAngle:(CGFloat) - M_PI_2
                                                                endAngle:(CGFloat)(- M_PI_2 + self.progress * 2 * M_PI)
                                                               clockwise:YES];
    
    
    layer.path = progressCircle.CGPath;
    layer.fillColor = [UIColor clearColor].CGColor;
    layer.strokeColor = kMainColor.CGColor;
    layer.lineCap = kCALineCapButt;
    
    
    CABasicAnimation *pathAnimation=[CABasicAnimation animationWithKeyPath:@"strokeEnd"];
    pathAnimation.duration = 3;
    pathAnimation.timingFunction=[CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionLinear];
    pathAnimation.fromValue=[NSNumber numberWithFloat:0.0f];
    pathAnimation.toValue=[NSNumber numberWithFloat:self.progress];
    pathAnimation.autoreverses=NO;
    
    pathAnimation.fillMode = kCAFillModeForwards;
    pathAnimation.removedOnCompletion = NO;
    pathAnimation.repeatCount = 1;
    [layer addAnimation:pathAnimation forKey:@"strokeEndAnimation"];
}
-(void)awakeFromNib
{
    
    [super awakeFromNib];
    self.backgroundColor = [UIColor getColor:@"EFF8FE"];
    //background color gradient
    [self drawCircle];

    _distanceLB = [[UILabel alloc]init];
    _distanceLB.text = @"00.00";//Futura-CondensedExtraBold
    _distanceLB.textColor = [UIColor getColor:@"2C4667"];
    _distanceLB.font = Kfont(70);//PingFangSC-Ultralight
    _distanceLB.textAlignment = NSTextAlignmentCenter;
    [self.gradientView addSubview:_distanceLB];
    [_distanceLB mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerY.mas_equalTo(10);
        make.centerX.mas_equalTo(0);
    }];
    
    UILabel *unitLabel = [[UILabel alloc]init];
    unitLabel.text = @"目标公里数(公里)";
    unitLabel.textColor = [UIColor getColor:@"2C4667"];
    unitLabel.textAlignment = NSTextAlignmentCenter;
    [self.gradientView addSubview:unitLabel];
    [unitLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerY.mas_equalTo(-40);;
        make.centerX.mas_equalTo(0);
    }];
    

//
//    [self.imageBack mas_makeConstraints:^(MASConstraintMaker *make) {
//        make.top.mas_equalTo(self.gradientView .mas_bottom).offset(55);
//        make.centerX.mas_equalTo(0);
//        make.left.right.mas_equalTo(27.5);
//    }];
    
    
    _timeLB = [[UILabel alloc]init];
    _timeLB.text = @"00:00";
    _timeLB.font = [UIFont fontWithName:@"HelveticaNeue-Medium" size:30];
    _timeLB.textColor = [UIColor getColor:@"2C4667"];
    [self.timeBackView addSubview:_timeLB];
    [_timeLB mas_makeConstraints:^(MASConstraintMaker *make) {
//        make.top.mas_equalTo(self.gradientView.mas_bottom).mas_equalTo(44);
//        //make.centerX.mas_equalTo(unitLabel.mas_centerX).mas_equalTo(-10);
        make.left.mas_equalTo(36);
//         make.left.mas_equalTo(36);
//          make.top.mas_equalTo(self.gradientView.mas_bottom).mas_equalTo(50);
        make.centerY.mas_equalTo(-15);
//        make.centerX.mas_equalTo(-30);
    }];
    
    UILabel *unit4Time =[UILabel new];
    unit4Time.text = @"分:秒";
    unit4Time.textColor = [UIColor getColor:@"2C4667"];
    unit4Time.font= [UIFont fontWithName:@"HelveticaNeue-light" size:16];
    [self.timeBackView addSubview:unit4Time];
    [unit4Time mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(_timeLB.mas_bottom).mas_equalTo(5);
        make.centerX.mas_equalTo(_timeLB.mas_centerX).mas_equalTo(0);
    }];
    
    
    
    _speedLB = [[UILabel alloc]init];
    _speedLB.text = @"00.00";
    _speedLB.textColor = [UIColor getColor:@"2C4667"];
    _speedLB.font = [UIFont fontWithName:@"HelveticaNeue-Medium" size:30];
    [self.timeBackView addSubview:_speedLB];
    [_speedLB mas_makeConstraints:^(MASConstraintMaker *make) {
//        make.top.mas_equalTo(self.gradientView.mas_bottom).mas_equalTo(50);
//        //make.centerX.mas_equalTo(unitLabel.mas_centerX).mas_equalTo(10);
        make.right.mas_equalTo(-36);
        
        
        make.centerY.mas_equalTo(-15);
//        make.centerX.mas_equalTo(30);
    }];
    
    UILabel *unit4Speed =[UILabel new];
    unit4Speed.text = @"距离(公里)";
    unit4Speed.textColor = [UIColor getColor:@"2C4667"];
    unit4Speed.font = [UIFont fontWithName:@"HelveticaNeue-light" size:16];
    [self.timeBackView addSubview:unit4Speed];
    [unit4Speed mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(_speedLB.mas_bottom).mas_equalTo(5);
        make.centerX.mas_equalTo(_speedLB.mas_centerX).mas_equalTo(0);
    }];
    
    
}
-(void)startTimer {
    [self resetRecord];
    if(!_timer) {
        _timer = [NSTimer scheduledTimerWithTimeInterval:1 target:self selector:@selector(changeTimeValue) userInfo:nil repeats:YES];
    }else {
        [_timer setFireDate:[NSDate distantPast]]; //开始
    }
}
-(void)stopTimer {
    //唯一的方法将_timer从runloop池中移除,invalite会让timer退出runloop,取消timer
    [_timer invalidate];
    _timer = nil;
    _timerNumber = 0;
}
-(void)changeTimeValue {
    _timerNumber ++;
    _timeLB.text = [NSString stringWithFormat:@"%.2ld:%.2ld",_timerNumber/60,_timerNumber%60];
}
-(void)resetRecord {
    _timeLB.text = @"00.00";
    _distanceLB.text = @"00.00";
    _speedLB.text = @"00.00";
    _timerNumber = 0;
    [_timer setFireDate:[NSDate distantFuture]]; //暂停
}
@end
