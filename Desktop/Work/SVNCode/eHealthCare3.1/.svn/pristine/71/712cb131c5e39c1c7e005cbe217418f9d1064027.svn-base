//
//  HomeViewController.m
//  eHealthCare
//
//  Created by John shi on 2018/7/2.
//  Copyright © 2018年 Jon Shi. All rights reserved.
//

#import "HomeViewController.h"
#import "HealthRecordController.h"
#import "HealthExamineController.h"
#import "HomeViewModel.h"
#import "MedicTableViewCell.h"
#import "InformationCell.h"
#import "HealthRecordController.h"
#import "XKNewHomeInSectionHeadView.h"
#import "SportViewController.h"
#import "XKNewHomeHeadView.h"
#import "XKMyPlanLookCell.h"
#import "AdvertiseModel.h"
#import "MallViewController.h"
#import "BreathTrainViewController.h"
#import "TrainWithMusicViewController.h"
#import "MusicTrainViewModel.h"
#import "XKInfomationViewController.h"
#import "QuietController.h"
@interface HomeViewController ()

@property (strong, nonatomic) XKNewHomeHeadView *headView;
@property (strong, nonatomic)  UITableView *tableView;
/**
 区头 头部试图
 */
@property (nonatomic,strong)XKNewHomeInSectionHeadView *headVO;
///热门话题
@property (nonatomic, strong) NSArray *HotTopicListArray;

///健康计划
@property (nonatomic, strong) NSArray *HealthPlanListArray;

///健康百科
@property (nonatomic, strong) NSArray *WikiListArray;

///广告
@property (nonatomic, strong) NSArray *AdvertiseListArray;

///运动步数公里数等
@property (nonatomic, strong) NSArray *StepEntityArray;

///心理疏导 早安、晚安、正念等
@property (nonatomic, strong) NSArray *EaseListArray;

@end

@implementation HomeViewController

#pragma mark life cycle
- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    

    [self createUI];
    self.extendedLayoutIncludesOpaqueBars = YES;
    if (@available(iOS 11.0, *)) {
        self.tableView.contentInsetAdjustmentBehavior = UIScrollViewContentInsetAdjustmentNever;
    } else {
        self.automaticallyAdjustsScrollViewInsets = NO;
        
    }
    //拉去首页数据
    [self getHotTopicHealthPlanAndMoreWithNetWorking];
}

#pragma mark UI
- (void)createUI
{

    self.tableView= [[UITableView alloc]initWithFrame:CGRectMake(0, 0, KScreenWidth, KScreenHeight-40) style:UITableViewStyleGrouped];
    self.tableView.delegate = self;
    self.tableView.dataSource = self;
    self.tableView.backgroundColor = [UIColor getColor:@"edf8ff"];
    self.tableView.tableHeaderView= self.headView;
    [self.view addSubview:self.tableView];
    self.tableView.estimatedRowHeight = 110;
    self.tableView.rowHeight = UITableViewAutomaticDimension;
    self.tableView.showsVerticalScrollIndicator=NO;
    self.tableView.showsHorizontalScrollIndicator=NO;
    self.tableView.separatorColor=[UIColor clearColor];
    [self.tableView registerNib:[UINib nibWithNibName:@"MedicTableViewCell" bundle:nil] forCellReuseIdentifier:@"cell"];

    [self.tableView registerNib:[UINib nibWithNibName:@"XKMyPlanLookCell" bundle:nil] forCellReuseIdentifier:@"XKMyPlanLookCell"];
     [self.tableView registerNib:[UINib nibWithNibName:@"InformationCell" bundle:nil] forCellReuseIdentifier:@"InformationCell"];
    
    
    NSUserDefaults *udf=[NSUserDefaults standardUserDefaults];
    
    NSArray *imgArr=[udf objectForKey:@"homePageImge"];
    
    imgArr=[AdvertiseModel objectArrayWithKeyValuesArray:imgArr];
    self.headView.imgArray=imgArr;
}


#pragma mark NetWorking
- (void)getHotTopicHealthPlanAndMoreWithNetWorking
{
    NSDictionary *dic = @{@"Token":[UserInfoTool getLoginInfo].Token,
                          @"MemberID":@([UserInfoTool getLoginInfo].MemberID),
                          @"PageIndex":@1,
                          @"PageSize":@3};
    
    [HomeViewModel getHotTopicHealthPlanAndMoreWithParams:dic FinishedBlock:^(ResponseObject *response) {
        
        if (response.code == CodeTypeSucceed) {
            
            self.HotTopicListArray = response.Result[@"HotTopicList"];
            
            self.HealthPlanListArray = response.Result[@"HealthPlanList"];
            
            self.WikiListArray = response.Result[@"WikiList"];
            
            self.AdvertiseListArray = response.Result[@"AdvertiseList"];
            
            self.StepEntityArray = response.Result[@"StepEntity"];
            
            self.EaseListArray = response.Result[@"EaseList"];
            
            
//            self.headView.imgArray = self.AdvertiseListArray;
            self.headView.imgArray=[AdvertiseModel objectArrayWithKeyValuesArray:response.Result[@"AdvertiseList"]];
            NSUserDefaults *ud=[NSUserDefaults standardUserDefaults];
            [ud setValue:response.Result[@"AdvertiseList"] forKey:@"homePageImge"];
        }else
        {
            ShowErrorStatus(response.msg);
        }
    }];
}
#pragma mark tableView dataSource
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
    return 3;
}
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    
    if (section==0) {
        return 1;
    }
    else{
        return 1;
    }
    
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {

   
   if (indexPath.section==0) {
        NSString *cellid = @"XKMyPlanLookCell";
        XKMyPlanLookCell *cell = [tableView dequeueReusableCellWithIdentifier:cellid];
        
//        cell.delegate = self;
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
//        cell.mod = _dataBigArr[indexPath.row];
       CAShapeLayer *maskTwoLayer = [[CAShapeLayer alloc] init];
       UIBezierPath *corTwoPath = [UIBezierPath bezierPathWithRoundedRect:CGRectMake(0, 0, KScreenWidth, (136)) byRoundingCorners:UIRectCornerBottomLeft | UIRectCornerBottomRight cornerRadii:CGSizeMake(5, 5)];
       maskTwoLayer.frame = corTwoPath.bounds;
       maskTwoLayer.path=corTwoPath.CGPath;
       cell.layer.mask=maskTwoLayer;
         return cell;

    }
    else  if (indexPath.section==2)
    {
        NSString *cellid = @"InformationCell";
        InformationCell *cell = [tableView dequeueReusableCellWithIdentifier:cellid];
        
//        cell.delegate = self;
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        return cell;
    }
    else
    {
        MedicTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@"cell" forIndexPath:indexPath];
        
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        
        cell.selectionStyle=UITableViewCellSelectionStyleNone;
        cell.delegate = self;
        return cell;
        
    }
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    if (section == 0){
        XKNewHomeInSectionHeadView *headV=[[[NSBundle mainBundle]loadNibNamed:@"XKNewHomeInSectionHeadView" owner:self options:nil]  firstObject];
        headV.titleLab.text=@"健康计划";
       headV.delegate = self;
        return headV;
    }else if (section == 1){
        XKNewHomeInSectionHeadView *headV=[[[NSBundle mainBundle]loadNibNamed:@"XKNewHomeInSectionHeadView" owner:self options:nil]  firstObject];
        headV.titleLab.text=@"健康百科";
        headV.delegate = self;
        headV.arrowImg.hidden = NO;
        return headV;
    }
    else{
        XKNewHomeInSectionHeadView *headV=[[[NSBundle mainBundle]loadNibNamed:@"XKNewHomeInSectionHeadView" owner:self options:nil]  firstObject];
        headV.titleLab.text=@"健康资讯";
         headV.delegate = self;
        return headV;
    }
    
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    if (section<=2) {
        return 45+10;
    }
    else
    {
        
        return 0.01;
    }
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return 0.01;
}
-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    
    if (indexPath.section==2) {
        return (246+10)*2+KHeight(45);
    }
    if (indexPath.section==1) {
        return 153;
    }
    else{
        return 126;
    }
    
}

-(XKNewHomeHeadView *)headView{
    
    if (!_headView) {
        
        _headView=[[[NSBundle mainBundle]loadNibNamed:@"XKNewHomeHeadView" owner:self options:nil]firstObject];
        _headView.left=0;
        _headView.top=0;
        _headView.width=KScreenWidth;
        if (IS_IPHONE5) {//13工具部分比之前多了13个像素点
            _headView.height=(779);//原来banner图高度是150  现在iPhone5的改为115
        }else if (IS_IPHONE6){
            _headView.height=809+20;//原来banner图高度是150  现在iPhone5的改为135
        }else{
            _headView.height=839+20;
        }
        _headView.delegate = self;
    }
    
    return _headView;
    
}


#pragma mark HealthTestHeadView Delegate
- (void)buttonClickAtIndex:(NSInteger)buttonIndex
{
    if (buttonIndex < 4)
    {
        if (buttonIndex == 1) {
            BreathTrainViewController *breath = [[BreathTrainViewController alloc]initWithType:pageTypeNoNavigation];
            [self.navigationController pushViewController:breath animated:YES];
        }
        else  if (buttonIndex == 3)
        {
            
          [self getMorningEverningAndMindfulnessListWithNetworking:3];
        }
        else  if (buttonIndex == 2)
        {
            
            [self getMorningEverningAndMindfulnessListWithNetworking:buttonIndex];
        }
        else  if (buttonIndex == 0)
        {
            
            SportViewController *sport = [[SportViewController alloc]initWithType:pageTypeNormal];
            [self.navigationController pushViewController:sport animated:YES];
        }
//        if (self.headViewDataArray.count == 0)
//        {
//            [AlertView showMessage:@"正在拉取数据,请稍后重试" withTitle:@"提示" sureButtonTitle:@"确定"];
//            return;
//        }

    }else
    {
        SensoryTestViewController *test = [[SensoryTestViewController alloc]initWithType:pageTypeNoNavigation];
        
        if (buttonIndex == 4)
        {
            //视力测试
            test.testType = sensoryTypeVision;
        }
        
        if (buttonIndex == 5)
        {
            //色觉测试
            test.testType = sensoryTypeColorVision;
        }
        
        if (buttonIndex == 6)
        {
            //柔韧度测试
            test.testType = sensoryTypeFist;
        }
        
        if (buttonIndex == 7)
        {
            //挥拳测试
            test.testType = sensoryTypeFlexibility;
        }
        
        [self.navigationController pushViewController:test animated:YES];
    }
}
- (void)buttonClickMainAtIndex:(NSString *)url title:(NSString *)title index:(NSInteger)tag;
{
    
    if (tag == 3) {
        XKInfomationViewController *info = [[XKInfomationViewController alloc]initWithType:pageTypeNormal];
//        info.myTitle = title;
        [self.navigationController pushViewController:info animated:YES];
    }else
    {
        //健康百科 健康计划
        HealthWiKiViewController *web = [[HealthWiKiViewController alloc]initWithType:pageTypeNormal];
        
        web.urlString = url;
        web.myTitle = title;
        
        [self.navigationController pushViewController:web animated:YES];
        
        
    }

    

    
}
-(void)buttonClickController:(NSString *)nameController urlString:(NSString *)url title:(NSString *)title;
{
    
//    Class classCon = NSClassFromString(nameController);
   
    id classCon = [[NSClassFromString(nameController) alloc]init];
    if ([classCon isKindOfClass:[NoralWebViewController class]]) {
        NoralWebViewController *web = classCon;
        web.urlString = url;
        web.myTitle = title;
        [self.navigationController pushViewController:web animated:YES];
        
    }
   else if ([classCon isKindOfClass:[HealthExamineController class]])
    {
        
        HealthExamineController *Examine = [[HealthExamineController alloc]initWithType:pageTypeNormal];
        [self.navigationController pushViewController:Examine animated:YES];
    }
    
    else  if ([classCon isKindOfClass:[HealthRecordController class]])
    {
        HealthRecordController *record = [[HealthRecordController alloc]initWithType:pageTypeNormal];
        [self.navigationController pushViewController:record animated:YES];
    }
    else  if ([classCon isKindOfClass:[MallViewController class]])
    {
        MallViewController *mall = [[MallViewController alloc]initWithType:pageTypeNormal];
        mall.homeAdvisterUrlStr = url;
        [self.navigationController pushViewController:mall animated:YES];
    }else if ([classCon isKindOfClass:[HealthWiKiViewController class]])
    {
        
        HealthWiKiViewController *web = [[HealthWiKiViewController alloc]initWithType:pageTypeNormal];
        
        web.urlString = url;
        web.myTitle = title;
        
        [self.navigationController pushViewController:web animated:YES];
        
    }
    
}
#pragma mark NetWorking
- (void)getMorningEverningAndMindfulnessListWithNetworking:(NSInteger)trainType;
{
    
    QuietController *train = [[QuietController alloc]initWithType:pageTypeNormal];
    train.isQuietOrMusic = (trainType == 2)?YES:NO;
    [self.navigationController pushViewController:train animated:YES];
    
  
}

#pragma mark  MedicTableViewCell 点击进入每个百科或者是咨询的详情页
-(void)XKMedicTableViewCellJoinAction:(NSInteger )cellIndex;
{
    
    HealthWiKiViewController *web = [[HealthWiKiViewController alloc]initWithType:pageTypeNormal];
    
    web.urlString = [NSString stringWithFormat:@"%@AppComm/BaikeIndex",kMainUrl];
    web.myTitle = @"健康百科";
    
    [self.navigationController pushViewController:web animated:YES];
    
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
