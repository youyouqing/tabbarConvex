//
//  ViewController.m
//  eHealthCare
//
//  Created by John shi on 2018/6/26.
//  Copyright © 2018年 Jon Shi. All rights reserved.
//

#import "ViewController.h"

#import "TabbarController.h"
#import "LoginViewController.h"

#import "AppDelegate.h"

#import "GuideView.h"

#import "CommonViewModel.h"

@interface ViewController ()

@property (nonatomic, strong) GuideView *guideView;

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view, typically from a nib.
    
    //判断当前版本是否是第一次进入App
    NSString *nowVersion = [[[NSBundle mainBundle] infoDictionary] objectForKey:@"CFBundleShortVersionString"];
    NSString *lastVersion = [[NSUserDefaults standardUserDefaults] stringForKey:@"lastVersion"];
    
    if(![nowVersion isEqualToString:lastVersion])
    {
        NSString *nowVersion = [[[NSBundle mainBundle] infoDictionary] objectForKey:@"CFBundleShortVersionString"];
        [[NSUserDefaults standardUserDefaults] setObject:nowVersion forKey:@"lastVersion"];
        [[NSUserDefaults standardUserDefaults] synchronize];
        
        [self loadGuidePageView];
        
    }else
    {
        [self isGoToLogin];
    }

}

#pragma mark 判断是否登录了
- (void)isGoToLogin
{
    //检查token是否失效
    if([UserInfoTool getLoginInfo].Token.length > 0)
    {
        [SingleTon shareInstance].token = [UserInfoTool getLoginInfo].Token;
        [SingleTon shareInstance].isLogin = YES;
        
        //检查token是否失效
        [CommonViewModel checkTokenIsFailureWithFinishedBlock:^(ResponseObject *response) {
            
            if (response.code != CodeTypeSucceed) {
                
                LoginViewController *login = [[LoginViewController alloc]init];
                [self presentViewController:login animated:YES completion:nil];
            }
        }];
    }
    
    if ([SingleTon shareInstance].isLogin)
    {
        [self setRootViewController];
        
    }else
    {
        LoginViewController *login = [[LoginViewController alloc]initWithType:pageTypeNoNavigation];
        
        login.loginSuccess = ^(UIViewController *viewController) {
            
            [self setRootViewController];
        };
        
        UINavigationController *nav = [[UINavigationController alloc]initWithRootViewController:login];
        nav.navigationBarHidden = YES;
        AppDelegate *appDelegate = (AppDelegate *)[[UIApplication sharedApplication] delegate];
        appDelegate.window.rootViewController = nav;
    }
}

#pragma mark 设置rootViewController
- (void)setRootViewController
{
    TabbarController *tab = [[TabbarController alloc]init];
    AppDelegate *appDelegate = (AppDelegate *)[[UIApplication sharedApplication] delegate];
    appDelegate.window.rootViewController = tab;
}

#pragma mark 加载引导页
- (void)loadGuidePageView
{
    [[UIApplication sharedApplication] setStatusBarHidden:YES];
    GuideView * guideView = [[GuideView alloc] initWithFrame:CGRectMake(0, 0, KScreenWidth, KScreenHeight)];
    [self.view addSubview:guideView];
    [self.view bringSubviewToFront:guideView];
    WEAKSELF
    [guideView setHideGuideViewBlock:^{
        weakSelf.guideView = nil;
        [weakSelf isGoToLogin];
    }];
    _guideView = guideView;
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}


@end
