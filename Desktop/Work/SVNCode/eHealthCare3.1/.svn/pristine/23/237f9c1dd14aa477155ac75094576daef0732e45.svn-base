//
//  SportDetailController.m
//  eHealthCare
//
//  Created by John shi on 2018/10/23.
//  Copyright © 2018年 Jon Shi. All rights reserved.
//

#import "SportDetailController.h"
#import "RunningView.h"
#import "BaiduMap_SportViewController.h"
#import "XKSpLockedView.h"
#import <CoreLocation/CoreLocation.h>
//定位头文件
#import <BaiduMapAPI_Location/BMKLocationComponent.h>
@interface SportDetailController ()
#define removeObjectsLen 20
@property(nonatomic,strong) BMKLocationService *locationService;

@property(nonatomic,strong) RunningView *runningView;

/**
 锁屏视图
 */
@property (nonatomic,strong)XKSpLockedView *lockedView;
@property (nonatomic,weak) UILabel *distanceLB;//目标公里数(公里)
@property (nonatomic,weak) UILabel *timeLB;
@property (nonatomic,weak) UILabel *speedLB;//距离(公里)
@property (nonatomic,assign)CGFloat totalDistance;//保存每次记录关闭的公里数

@end

@implementation SportDetailController
/**
 改变view的透明图
 */
- (void)changeView:(BOOL)isUnLock{
    
    XKSpLockedView *myLockedView = [[NSBundle mainBundle]loadNibNamed:@"XKSpLockedView" owner:nil options:nil].lastObject;
    
    _lockedView = myLockedView;
    
    myLockedView.frame = [UIScreen mainScreen].bounds;
    
    myLockedView.delegate = self;
    
    [[UIApplication sharedApplication].keyWindow addSubview:myLockedView];
    
}

-(RunningView *)runningView {
    if(!_runningView) {
        _runningView = [[[NSBundle mainBundle] loadNibNamed:@"RunningView" owner:self options:nil] firstObject];
        _runningView.x = 0;
        _runningView.y = 0;
        _runningView.width = KScreenWidth;
        _runningView.height = KScreenHeight;
        _runningView.delegate = self;
    }
    return _runningView;
}
- (void)viewDidLoad {
    [super viewDidLoad];
    self.view = self.runningView;
     self.presentControllerButton = self.runningView.mapButton;
     [self presentMapVC];
     [self loadSharedRCLocationManagerInstance];
    //更新数据时减少getter访问的次数[???]
    self.distanceLB = self.runningView.distanceLB;
    self.timeLB = self.runningView.timeLB;
    self.speedLB = self.runningView.speedLB;
    [self.locationManager startTimer];
 
}
-(void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    //这里一定要再设置一次，因为如果从地图页面过来的，viewDidLoad()不会再加载了，只会加载viewWillAppear:方法
    self.locationManager.delegate = self;
   
    [self continueTimer];
}
-(void)viewWillDisappear:(BOOL)animated {
    [super viewWillDisappear:animated];
    [self stopTime];
}
-(void)stopRecord {
    [self.locationManager stopUpdatingLocation];
    self.locationManager.delegate = nil;
    //这一句不用加，因为locationManager是个单例，它的dealloc方法永远不会被调用，因为在程序的生命周期内，该单例一直都存在
    self.locationManager = nil;
}
-(void)loadSharedRCLocationManagerInstance {
    BaiduMapTrackManager *locationManager = [BaiduMapTrackManager shareInstance];
    if(!locationManager.running) {
        //开始定位,这时locationManager.running = YES;直到点击暂停按钮再把locationManager.running = NO;
        //即running从该VC一加载算起，直到停止按钮点击的时候停止
        //不能把running理解为跑步的时候为true,停止下来休息的时候为false
        locationManager.delegate = self;
        [locationManager startUpdatingLocation];
    }
    self.locationManager = locationManager;
}

-(void)stopTime {
    //关闭定时器
    [self.locationManager.timer setFireDate:[NSDate distantFuture]];
}
-(void)presentMapVC {
    [self.runningView.mapButton addTarget:self action:@selector(mapShow) forControlEvents:UIControlEventTouchUpInside];
}
-(void)mapShow {
    BaiduMap_SportViewController *mapVc = [[BaiduMap_SportViewController alloc]initWithType:pageTypeNoNavigation];
    mapVc.locationManager = self.locationManager;
     mapVc.locations = [NSMutableArray arrayWithArray:self.locationManager.locations];
    [self presentLHViewController:mapVc tapView:self.runningView.mapButton color:nil animated:YES completion:^{

    }];
//     [self.navigationController pushViewController:mapVc animated:YES];
    
}
-(void)continueTimer {
    if(self.locationManager.running) {
        [self.locationManager.timer setFireDate:[NSDate distantPast]];
//        NSDate *nowDate = [[NSDate alloc] init];
//        NSTimeInterval timeInterval = [nowDate timeIntervalSinceDate:self.locationManager.startLocationDate];
//        self.locationManager.timerNumber = (NSInteger)timeInterval;
        
          self.runningView.timeLB.text = [NSString stringWithFormat:@"%.2ld:%.2ld",self.locationManager.timerNumber/60,self.locationManager.timerNumber%60];
    }
}
#pragma mark- RCLocationManagerDelegate
-(void)locationManager:(BaiduMapTrackManager *)manager didUpdatedLocations:(NSArray<CLLocation *> *)locations {
    //NSLog(@"%@",manager); //<RCLocationManager: 0x156f95860>,
    //占位符 '%0M.Nlf'表示小数点为N位，长度为M-1位，如3.1--->%05.2lf-->03.10
    self.distanceLB.text = [NSString stringWithFormat:@"%05.2lf",manager.totalDistance/1000.0];
    NSLog(@"%@",self.distanceLB.text);
    self.totalDistance = [self.distanceLB.text floatValue];
    self.speedLB.text = [NSString stringWithFormat:@"%05.2lf",manager.speed > 0 ? manager.speed:0];
}

-(void)locationManager:(BaiduMapTrackManager *)manager didChangeLocationsState:(BOOL)running {
    if(running) {
        [self.locationManager startTimer];
        UIApplication *app = [UIApplication sharedApplication];
        //接收当前的UIApplication[单例]发送的通知，然后处理selector
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(continueTimer) name:UIApplicationWillEnterForegroundNotification object:app];
        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(stopTime) name:UIApplicationDidEnterBackgroundNotification object:app];
        
    }else {
   
    }
}
-(void)locationManagerTime:(NSInteger)timerNumber;
{
    
    self.runningView.timeLB.text = [NSString stringWithFormat:@"%.2ld:%.2ld",timerNumber/60,timerNumber%60];
    
}
#pragma mark  解锁
- (void)unLocked{
    
    [self.lockedView removeFromSuperview];
    
    self.lockedView = nil;

    
}
#pragma mark  解锁
- (void)lockOrunLockBtn;
{
     [self changeView:YES];
    
}
- (void)suspendOrunKeep:(BOOL)keep;
{
    if (keep == YES) {
        [self continueTimer];
         [self loadSharedRCLocationManagerInstance];
    }else
    {
          [self.locationManager pauseRecord];
          [self stopRecord];
    }
    
    
    
}
-(void)stopActionBtn;
{
    [self stopRecord];
    
    
    //点击停止按钮后
    [self.locationManager stopTimer];
    //下面开始做保存的工作
    if(self.locationManager.locations.count < 3) {
        [self.locationManager resetRecord];
        //弹出
        UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"温馨提示" message:@"距离太短,无法保存" preferredStyle:UIAlertControllerStyleAlert];
        
        UIAlertAction *doAction = [UIAlertAction actionWithTitle:@"确定" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            [self.navigationController popToRootViewControllerAnimated:YES];
        }];
        
        [alert addAction:doAction];
        [self presentViewController:alert animated:YES completion:nil];
    }else if(self.locationManager.locations.count >= 3) {
        
        dispatch_async(dispatch_get_global_queue(QOS_CLASS_USER_INITIATED, 0), ^{
            
            
            
            //主线程中更新UI
            dispatch_async(dispatch_get_main_queue(), ^{
                
                
                
                
            });
        });
    }
    
    
    
    [[NSNotificationCenter defaultCenter] removeObserver:self name:UIApplicationWillEnterForegroundNotification object:nil];
    [[NSNotificationCenter defaultCenter] removeObserver:self name:UIApplicationDidEnterBackgroundNotification object:nil];
    [self.navigationController popViewControllerAnimated:YES];
}
-(void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    NSRange range = NSMakeRange(0, removeObjectsLen);
    [self.locationManager.locations removeObjectsInRange:range];
    
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
